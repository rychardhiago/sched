<?php session_name("login_sched");session_start ();ini_set("memory_limit","400M");ini_set ('allow_url_fopen', true);set_time_limit(9999);require('fpdf/alphapdf.php');class PDF extends AlphaPDF{    function SetTitle($title, $isUTF8=false)    {        // Title of document        $this->metadata['Title'] = $isUTF8 ? $title : utf8_encode($title);    }    function SetAuthor($author, $isUTF8=false)    {        // Author of document        $this->metadata['Author'] = $isUTF8 ? $author : utf8_encode($author);    }    function SetSubject($subject, $isUTF8=false)    {        // Subject of document        $this->metadata['Subject'] = $isUTF8 ? $subject : utf8_encode($subject);    }    // Page footer    function Footer()    {        // Position at 1.5 cm from bottom        $this->SetY(-15);        // Arial italic 8        $this->SetFont('Arial','I',8);        // Page number        $this->Cell(0,10,'Schedapp -  '.$this->PageNo().'/{nb}',0,0,'C');    }    // Simple table    function BasicTable($header, $data)    {        // Header        foreach($header as $col)            $this->Cell(40,7,$col,1);        $this->Ln();        // Data        foreach($data as $row)        {            foreach($row as $col)                $this->Cell(40,6,$col,1);            $this->Ln();        }    }// Better table    function ImprovedTable($header, $data)    {        // Column widths        $w = array(40, 35, 40, 45);        // Header        $this->SetTextColor(0,0,0);        for($i=0;$i<count($header);$i++)            $this->Cell($w[$i],7,$header[$i],0,0,'C');        $this->Ln();        $this->Cell(array_sum($w),0,'','T');        $this->Ln();        $this->SetTextColor(100,100,100);        // Data        foreach($data as $row)        {            $this->Cell($w[0],6,$row[0],'');            $this->Cell($w[1],6,$row[1],'');            $this->Cell($w[2],6,$row[2],'');            $this->Cell($w[3],6,$row[3],'');            $this->Ln();        }        // Closing line        $this->Cell(array_sum($w),0,'','T');    }    function FancyTableH($header)    {        // Colors, line width and bold font        $this->SetFillColor(255,255,255);        $this->SetTextColor(100,100,100);        $this->SetLineWidth(.3);        $this->SetFont('','');        // Header        $w = array(40, 35, 40, 45, 35);        for($i=0;$i<count($header);$i++)            $this->Cell($w[$i],7,$header[$i],'B',0,'C',true);        $this->Ln();    }    function FancyTableB($data)    {        // Color and font restoration        $this->SetFillColor(224,235,255);        $this->SetTextColor(100,100,100);        $this->SetFont('','I',10);        $w = array(40, 35, 40, 45, 35);        $fill = false;        foreach($data as $row)        {            $this->Cell($w[0],9,$row[0],'',0,'L',$fill);            $this->Cell($w[1],9,$row[1],'',0,'L',$fill);            $this->Cell($w[2],9,$row[2],'',0,'R',$fill);            $this->Cell($w[3],9,$row[3],'',0,'R',$fill);            $this->Cell($w[4],9,$row[4],'',0,'R',$fill);            $this->Ln();            $fill = !$fill;        }        // Closing line        //$this->Cell(array_sum($w),0,'','T');    }// Colored table    function FancyTable($header, $data, $nomecliente = '')    {        // Colors, line width and bold font        $this->SetFillColor(255,255,255);        $this->SetTextColor(100,100,100);        $this->SetLineWidth(.3);        $this->SetFont('','');        if($nomecliente != '') {            $this->SetFont('Arial','B',12);            $this->SetTextColor(253, 163, 14);            $this->Cell(0,7,utf8_decode($nomecliente),0,0,'L');            $this->Ln();            $this->SetTextColor(100,100,100);            $this->SetFont('Arial','I',12);        }        // Header        $w = array(30, 30, 40, 55, 35);        for($i=0;$i<count($header);$i++)            $this->Cell($w[$i],7,$header[$i],'B',0,'C',true);        if(count($header) > 0) {            $this->Ln();        }        // Color and font restoration        $this->SetFillColor(224,235,255);        $this->SetTextColor(100,100,100);        $this->SetFont('','I',10);        // Data        $fill = false;        foreach($data as $row)        {            $this->Cell($w[0],9,$row[0],'',0,'L',$fill);            $this->Cell($w[1],9,$row[1],'',0,'L',$fill);            $this->Cell($w[2],9,$row[2],'',0,'R',$fill);            $this->Cell($w[3],9,$row[3],'',0,'R',$fill);            $this->Cell($w[4],9,$row[4],'',0,'R',$fill);            $this->Ln();            $fill = !$fill;        }        // Closing line        //$this->Cell(array_sum($w),0,'','T');    }    function FancyTable2($header, $data)    {        // Colors, line width and bold font        $this->SetFillColor(255,255,255);        $this->SetTextColor(100,100,100);        $this->SetLineWidth(.3);        $this->SetFont('','');        // Header        $w = array(30, 30, 30, 35, 70);        for($i=0;$i<count($header);$i++)            $this->Cell($w[$i],7,$header[$i],'B',0,'C',true);        $this->Ln();        // Color and font restoration        $this->SetFillColor(224,235,255);        $this->SetTextColor(100,100,100);        $this->SetFont('','I',10);        // Data        $fill = false;        foreach($data as $row)        {            $this->Cell($w[0],9,$row[0],'',0,'L',$fill);            $this->Cell($w[1],9,$row[1],'',0,'L',$fill);            $this->Cell($w[2],9,$row[2],'',0,'R',$fill);            $this->Cell($w[3],9,$row[3],'',0,'R',$fill);            $this->Cell($w[4],9,$row[4],'',0,'R',$fill);            $this->Ln();            $fill = !$fill;        }        // Closing line        //$this->Cell(array_sum($w),0,'','T');    }}$pdf = new PDF();if($_REQUEST['tipo'] == 'F'){    $rel = 'Relatório Financeiro';}else if($_REQUEST['tipo'] == 'A'){    $rel = 'Relatório de Agendamentos';}else if($_REQUEST['tipo'] == 'C'){    $rel = 'Relatório de Cancelamentos';}else if($_REQUEST['tipo'] == 'B'){    $rel = 'Relatório de Bloqueios';}else if($_REQUEST['tipo'] == 'L'){    $rel = 'Relatório de Clientes';}$pdf->SetTitle(utf8_decode($rel));$pdf->SetAuthor('Schedapp');$pdf->AliasNbPages();$pdf->AddPage();$pdf->SetFont('Arial','B',18);$pdf->SetTextColor(253, 163, 14);$pdf->Cell(0,0,utf8_decode($rel),0,0,'C');$pdf->Ln(16);$pdf->SetTextColor(100,100,100);$pdf->SetFont('Arial','I',12);/** * Agendamentos */if($_REQUEST['tipo'] == 'A'){require_once('classes/class.agendamentos.php');$agendamento = new agendamentos();$sql   = "SELECT agendamentos.agendamentoid, agendamentos.datainicio, agendamentos.datafim, agendamentos.obscli, agendamentos.obsemp, agendamentos.cancelado ";$sql  .= ", agendamentos.datacancel , agendamentos.interno, ifnull(agendamentos.profausente,'N') profausente, agendamentos.nomecliente, agendamentos.tempototal ";$sql  .= ", agendamentos.precototal, agendamentos.compareceu, ifnull(agendamentos.interno, 'N') interno, profissionais.nome, empresas.nomefantasia empresa, agendamentos.servicos  ";$sql  .= "FROM agendamentos, profissionais, empresas ";$sql  .= "WHERE agendamentos.profissionaiid = profissionais.profissionaiid and agendamentos.empresaid = empresas.empresaid ";$sql .= " and empresas.empresaid = ".$_REQUEST['empresaid'];// FILTROSif(($_REQUEST['dtinicio'] != '') and ($_REQUEST['dtfim'] != '')){	$start = strtotime($_REQUEST['dtinicio']);	$end = strtotime($_REQUEST['dtfim']);    $sql .= " and (datainicio BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "' or datafim BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "') ";}if($_REQUEST['profissionaiid'] != '') {    $sql .= " and agendamentos.profissionaiid = ".$_REQUEST['profissionaiid'];}if($_REQUEST['clienteid'] != '') {    $sql .= " and agendamentos.clienteid = ".$_REQUEST['clienteid'];}else if($_REQUEST['clientenome'] != '') {    $sql .= " and agendamentos.nomecliente LIKE '%".$_REQUEST['clientenome']."%'";}if(($_REQUEST['servicos'] != '') && ($_REQUEST['servicos'] != 'null')) {    $sql .= " and agendamentos.servicos LIKE '%".$_REQUEST['servicos']."%'";}$sql .= ' order by datainicio';$stmt = $agendamento->runQuery($sql);$stmt->execute();$data = array();while($tipo = $stmt->fetch()) {    $dtinicio = date('d/m/Y H:i',strtotime($tipo['datainicio']));    $dtfim = date('d/m/Y H:i',strtotime($tipo['datafim']));	$data[] = array(        $dtinicio,		$dtfim,        utf8_decode($tipo['nomecliente']),        utf8_decode($tipo['nome']),        'R$ '.number_format($tipo['precototal'], 2, ',', '.')    );}$header = array(utf8_decode('Data início'), 'Data fim', 'Cliente', 'Profissional', 'Valor total');$pdf->FancyTable($header,$data);//$pdf->MultiCell(0,4,$sql);}/** * FIM Agendamentos *//** * Clientes */if($_REQUEST['tipo'] == 'L'){    require_once('classes/class.agendamentos.php');    $agendamento = new agendamentos();    $sql   = "SELECT agendamentos.agendamentoid, agendamentos.datainicio, agendamentos.datafim, agendamentos.obscli, agendamentos.obsemp, agendamentos.cancelado ";    $sql  .= ", agendamentos.datacancel , agendamentos.interno, ifnull(agendamentos.profausente,'N') profausente, agendamentos.nomecliente, agendamentos.tempototal ";    $sql  .= ", agendamentos.precototal, agendamentos.compareceu, ifnull(agendamentos.interno, 'N') interno, profissionais.nome, empresas.nomefantasia empresa, agendamentos.servicos  ";    $sql  .= "FROM agendamentos, profissionais, empresas ";    $sql  .= "WHERE agendamentos.profissionaiid = profissionais.profissionaiid and agendamentos.empresaid = empresas.empresaid ";    $sql .= " and empresas.empresaid = ".$_REQUEST['empresaid'];// FILTROS    if(($_REQUEST['dtinicio'] != '') and ($_REQUEST['dtfim'] != '')){        $start = strtotime($_REQUEST['dtinicio']);        $end = strtotime($_REQUEST['dtfim']);        $sql .= " and (datainicio BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "' or datafim BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "') ";    }    if($_REQUEST['profissionaiid'] != '') {        $sql .= " and agendamentos.profissionaiid = ".$_REQUEST['profissionaiid'];    }    if($_REQUEST['clienteid'] > 0) {        $sql .= " and agendamentos.clienteid = ".$_REQUEST['clienteid'];    }    else if($_REQUEST['clientenome'] != '') {        $sql .= " and agendamentos.nomecliente LIKE '%".$_REQUEST['clientenome']."%'";    }    if(($_REQUEST['servicos'] != '') && ($_REQUEST['servicos'] != 'null')) {        $sql .= " and agendamentos.servicos LIKE '%".$_REQUEST['servicos']."%'";    }    $sql .= ' order by nomecliente, datainicio';    $stmt = $agendamento->runQuery($sql);    $stmt->execute();    $data = array();    $nomecliente = '';    $y = 4; //echo $sql;    while($tipo = $stmt->fetch()) {        $dtinicio = date('d/m/Y H:i',strtotime($tipo['datainicio']));        $dtfim = date('d/m/Y H:i',strtotime($tipo['datafim']));        $sq = 'Select * from servicos where servicoid in ('.$tipo['servicos'].') and empresaid ='.$_SESSION['empresaid'];        $st = $agendamento->runQuery($sq);        $st->execute();        $servicos = '';        while($tip = $st->fetch()) {            $servicos .= $tip['nome'].' ';        }        $data[] = array(            $dtinicio,            $dtfim,            utf8_decode($tipo['nome']),            utf8_decode($servicos),            'R$ '.number_format($tipo['precototal'], 2, ',', '.')        );        if($tipo['nomecliente'] != $nomecliente) {            $nomecliente = $tipo['nomecliente'];            $header = array(utf8_decode('Data início'), 'Data fim', 'Profissional', utf8_decode('Serviços'), 'Valor total');            $pdf->Ln();            $pdf->FancyTable($header,array(),$nomecliente);        }        $pdf->FancyTable(array(),$data);        unset($data);    }}/** * FIM Clientes *//** * Financeiro */if($_REQUEST['tipo'] == 'F'){    require_once('classes/class.agendamentos.php');    $agendamento = new agendamentos();    $s =  "select profissionaiid, usacomissao from profissionais, empresas where ";    $s .= " profissionais.empresaid = empresas.empresaid and empresas.empresaid = ".$_REQUEST['empresaid'];    if($_REQUEST['profissionaiid'] != '') {        $sql .= " and profissionaiid = ".$_REQUEST['profissionaiid'];    }    $st = $agendamento->runQuery($s);    $st->execute();    $i = 0;    while ($prof = $st->fetch()) {        $sql = "SELECT agendamentos.agendamentoid, agendamentos.datainicio, agendamentos.datafim, agendamentos.obscli, agendamentos.obsemp, agendamentos.cancelado ";        $sql .= ", agendamentos.datacancel , agendamentos.interno, ifnull(agendamentos.profausente,'N') profausente, agendamentos.nomecliente, agendamentos.tempototal ";        $sql .= ", agendamentos.precototal, agendamentos.compareceu, ifnull(agendamentos.interno, 'N') interno, profissionais.nome, empresas.nomefantasia empresa, agendamentos.servicos  ";        $sql .= ", empresas.usacomissao , agendamentos.profissionaiid ";        $sql .= "FROM agendamentos, profissionais, empresas ";        $sql .= "WHERE agendamentos.profissionaiid = profissionais.profissionaiid and agendamentos.empresaid = empresas.empresaid and cancelado = 'N'";        $sql .= " and empresas.empresaid = " . $_REQUEST['empresaid'];        $sql .= " and agendamentos.profissionaiid = " . $prof['profissionaiid'];        // FILTROS        if (($_REQUEST['dtinicio'] != '') and ($_REQUEST['dtfim'] != '')) {            $start = strtotime($_REQUEST['dtinicio']);            $end = strtotime($_REQUEST['dtfim']);            $sql .= " and (datainicio BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "' or datafim BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "') ";        }        if ($_REQUEST['clientenome'] != '') {            $sql .= " and agendamentos.nomecliente LIKE '%" . $_REQUEST['clientenome'] . "%'";        }        if (($_REQUEST['servicos'] != '') && ($_REQUEST['servicos'] != 'null')) {            $sql .= " and agendamentos.servicos LIKE '%" . $_REQUEST['servicos'] . "%'";        }        $sql .= ' order by agendamentos.profissionaiid,datainicio';        $stmt = $agendamento->runQuery($sql);        $stmt->execute();        $data = '';        $data = array();        $total = 0;        $totalcomissao = 0;        while ($tipo = $stmt->fetch()) {            $dtinicio = date('d/m/Y H:i', strtotime($tipo['datainicio']));            $dtfim = date('d/m/Y H:i', strtotime($tipo['datafim']));            $profissional = $tipo['profissionaiid'];            $valorcomissao = 0;            if ($tipo['usacomissao'] == 'S') {                $sq = "select tipocomissao, valorcomissao, preco from servicos, relservicosprofissionais ";                $sq .= "where servicos.servicoid = relservicosprofissionais.servicoid and servicos.servicoid in (" . $tipo['servicos'] . ") and profissionaiid = " . $profissional;                $stm = $agendamento->runQuery($sq);                $stm->execute();                while ($servicos = $stm->fetch()) {                    if ($servicos['tipocomissao'] == 'P') {                        $valorcomissao = $valorcomissao + ($servicos['preco'] * ($servicos['valorcomissao'] / 100));                    } else {                        $valorcomissao = $valorcomissao + $servicos['valorcomissao'];                    }                }            }            if ($tipo['usacomissao'] == 'S') {                $data[] = array(                    $dtinicio,                    $dtfim,                    utf8_decode($tipo['nome']),                    'R$ ' . number_format($tipo['precototal'], 2, ',', '.'),                    'R$ ' . number_format($valorcomissao, 2, ',', '.')                );                $totalcomissao = $totalcomissao + $valorcomissao;            } else {                $data[] = array(                    $dtinicio,                    $dtfim,                    utf8_decode($tipo['nome']),                    'R$ ' . number_format($tipo['precototal'], 2, ',', '.'),                    ' - '                );            }            $usacomissao = $tipo['usacomissao'];            $total = $total + $tipo['precototal'];        }        if($prof['usacomissao'] == 'S') {            $header = array(utf8_decode('Data início'), 'Data fim', 'Profissional', 'Valor total', utf8_decode('Valor da comissão'));        }        else {            $header = array(utf8_decode('Data início'), 'Data fim', 'Profissional', 'Valor total', ' - ');        }        if(count($data) > 0) {            $pdf->FancyTable($header, $data);            $pdf->Ln();            $pdf->SetFont('Arial', 'B', 12);            $pdf->Cell(120, 9, '', 'T');            $pdf->Cell(120, 9, 'Total            R$ ' . number_format($total, 2, ',', '.') . '          R$ ' . number_format($totalcomissao, 2, ',', '.'), '');            $pdf->Ln();            $pdf->Ln();        }    }    //$pdf->MultiCell(0,4,$sql);}/** * FIM Financeiro *//** * Cancelamentos */if($_REQUEST['tipo'] == 'C'){    require_once('classes/class.agendamentos.php');    $agendamento = new agendamentos();    $sql   = "SELECT agendamentos.agendamentoid, agendamentos.datainicio, agendamentos.datafim, agendamentos.obscli, agendamentos.obsemp, agendamentos.cancelado ";    $sql  .= ", agendamentos.datacancel , agendamentos.interno, ifnull(agendamentos.profausente,'N') profausente, agendamentos.nomecliente, agendamentos.tempototal ";    $sql  .= ", agendamentos.precototal, agendamentos.compareceu, ifnull(agendamentos.interno, 'N') interno, profissionais.nome, empresas.nomefantasia empresa, agendamentos.servicos  ";    $sql  .= ", agendamentos.datacancel, agendamentos.obscancel ";    $sql  .= "FROM agendamentos, profissionais, empresas ";    $sql  .= "WHERE agendamentos.profissionaiid = profissionais.profissionaiid and agendamentos.empresaid = empresas.empresaid ";    $sql  .= " and empresas.empresaid = ".$_REQUEST['empresaid'];    $sql  .= " and cancelado = 'S'";// FILTROS    if(($_REQUEST['dtinicio'] != '') and ($_REQUEST['dtfim'] != '')){        $start = strtotime($_REQUEST['dtinicio']);        $end = strtotime($_REQUEST['dtfim']);        $sql .= " and (datainicio BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "' or datafim BETWEEN '" . date('Y-m-d H:i:s', $start) . "' and '" . date('Y-m-d H:i:s', $end) . "') ";    }    if($_REQUEST['profissionaiid'] != '') {        $sql .= " and agendamentos.profissionaiid = ".$_REQUEST['profissionaiid'];    }    if($_REQUEST['clientenome'] != '') {        $sql .= " and agendamentos.nomecliente LIKE '%".$_REQUEST['clientenome']."%'";    }    if(($_REQUEST['servicos'] != '') && ($_REQUEST['servicos'] != 'null')) {        $sql .= " and agendamentos.servicos LIKE '%".$_REQUEST['servicos']."%'";    }    $sql .= ' order by datainicio';    $stmt = $agendamento->runQuery($sql);    $stmt->execute();    $data = array();    while($tipo = $stmt->fetch()) {        $dtinicio = date('d/m/Y H:i',strtotime($tipo['datainicio']));        $dtfim = date('d/m/Y H:i',strtotime($tipo['datafim']));        $datacancel = date('d/m/Y H:i',strtotime($tipo['datacancel']));        $data[] = array(            $dtinicio,            $dtfim,            utf8_decode($tipo['nome']),            $datacancel,            utf8_decode($tipo['obscancel'])        );    }    $header = array(utf8_decode('Data início'), 'Data fim', 'Profissional', 'Data Cancel', utf8_decode('Observação'));    $pdf->FancyTable2($header,$data);//$pdf->MultiCell(0,4,$sql);}/** * FIM Cancelamentos */$pdf->Output();?>